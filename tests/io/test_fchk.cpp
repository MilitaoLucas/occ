#include "catch.hpp"
#include <fmt/ostream.h>
#include <occ/core/util.h>
#include <occ/io/fchkreader.h>
#include <occ/io/fchkwriter.h>
#include <sstream>

using occ::Mat;

const char *fchk_contents = R"(h2
SP        RB3LYP                                                      STO-3G
Number of atoms                            I                2
Info1-9                                    I   N=           9
           9           9           0           0           0         110
           1          18        -502
Charge                                     I                0
Multiplicity                               I                1
Number of electrons                        I                2
Number of alpha electrons                  I                1
Number of beta electrons                   I                1
Number of basis functions                  I                2
Number of independent functions            I                2
Number of point charges in /Mol/           I                0
Number of translation vectors              I                0
Atomic numbers                             I   N=           2
           1           1
Nuclear charges                            R   N=           2
  1.00000000E+00  1.00000000E+00
Current cartesian coordinates              R   N=           6
  0.00000000E+00  0.00000000E+00  6.99198669E-01  8.56271412E-17  0.00000000E+00
 -6.99198669E-01
Force Field                                I                0
Int Atom Types                             I   N=           2
           0           0
MM charges                                 R   N=           2
  0.00000000E+00  0.00000000E+00
Integer atomic weights                     I   N=           2
           1           1
Real atomic weights                        R   N=           2
  1.00782504E+00  1.00782504E+00
Atom fragment info                         I   N=           2
           0           0
Atom residue num                           I   N=           2
           0           0
Nuclear spins                              I   N=           2
           1           1
Nuclear ZEff                               R   N=           2
 -1.00000000E+00 -1.00000000E+00
Nuclear ZNuc                               R   N=           2
  1.00000000E+00  1.00000000E+00
Nuclear QMom                               R   N=           2
  0.00000000E+00  0.00000000E+00
Nuclear GFac                               R   N=           2
  2.79284600E+00  2.79284600E+00
MicOpt                                     I   N=           2
          -1          -1
Number of contracted shells                I                2
Number of primitive shells                 I                6
Pure/Cartesian d shells                    I                0
Pure/Cartesian f shells                    I                0
Highest angular momentum                   I                0
Largest degree of contraction              I                3
Shell types                                I   N=           2
           0           0
Number of primitives per shell             I   N=           2
           3           3
Shell to atom map                          I   N=           2
           1           2
Primitive exponents                        R   N=           6
  3.42525091E+00  6.23913730E-01  1.68855404E-01  3.42525091E+00  6.23913730E-01
  1.68855404E-01
Contraction coefficients                   R   N=           6
  1.54328967E-01  5.35328142E-01  4.44634542E-01  1.54328967E-01  5.35328142E-01
  4.44634542E-01
Coordinates of each shell                  R   N=           6
  0.00000000E+00  0.00000000E+00  6.99198669E-01  8.56271412E-17  0.00000000E+00
 -6.99198669E-01
Constraint Structure                       R   N=           6
  0.00000000E+00  0.00000000E+00  6.99198669E-01  8.56271412E-17  0.00000000E+00
 -6.99198669E-01
Num ILSW                                   I              100
ILSW                                       I   N=         100
           0           0           0           0           2           0
           0           0           0           0         402          -1
           0           0           0           0           0           0
           0           0           0           0           0           0
           1           0           0           0           0           0
           0           0      100000           0          -1           0
           0           0           0           0           0           0
           0           0           0           1           0           0
           0           0           1           0           0           0
           0           0           4          41           0           0
           0           0           5           0           0           0
           0           0           0           2           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Num RLSW                                   I               41
RLSW                                       R   N=          41
  8.00000000E-01  7.20000000E-01  1.00000000E+00  8.10000000E-01  2.00000000E-01
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00
MxBond                                     I                1
NBond                                      I   N=           2
           1           1
IBond                                      I   N=           2
           2           1
RBond                                      R   N=           2
  1.00000000E+00  1.00000000E+00
Virial Ratio                               R      1.970141361625062E+00
SCF Energy                                 R     -1.165418375762579E+00
Total Energy                               R     -1.165418375762579E+00
External E-field                           R   N=          35
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
IOpCl                                      I                0
IROHF                                      I                0
Alpha Orbital Energies                     R   N=           2
 -4.14539570E-01  4.27590260E-01
Alpha MO coefficients                      R   N=           4
  5.48842275E-01  5.48842275E-01  1.21245192E+00 -1.21245192E+00
Total SCF Density                          R   N=           3
  6.02455687E-01  6.02455687E-01  6.02455687E-01
Mulliken Charges                           R   N=           2
 -2.77555756E-16 -3.33066907E-16
ONIOM Charges                              I   N=          16
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
ONIOM Multiplicities                       I   N=          16
           1           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Atom Layers                                I   N=           2
           1           1
Atom Modifiers                             I   N=           2
           0           0
Force Field                                I                0
Int Atom Modified Types                    I   N=           2
           0           0
Link Atoms                                 I   N=           2
           0           0
Atom Modified MM Charges                   R   N=           2
  0.00000000E+00  0.00000000E+00
Link Distances                             R   N=           8
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Cartesian Gradient                         R   N=           6
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00
Dipole Moment                              R   N=           3
 -1.23259516E-32  0.00000000E+00  5.55111512E-17
Quadrupole Moment                          R   N=           6
 -1.04128604E-01 -1.04128604E-01  2.08257207E-01  0.00000000E+00 -1.91281142E-17
  0.00000000E+00
QEq coupling tensors                       R   N=          12
  1.83153654E-01  0.00000000E+00  1.83153654E-01  4.89879653E-17  0.00000000E+00
 -3.66307308E-01  1.83153654E-01  0.00000000E+00  1.83153654E-01  1.34443277E-17
  0.00000000E+00 -3.66307308E-01
)";

const char *unrestricted_fchk_contents =
    R"(water                                                                   
SP        UHF                                                         3-21G               
Number of atoms                            I                3
Info1-9                                    I   N=           9
          10          10           0           0           0         111
           1           1           2
Charge                                     I                0
Multiplicity                               I                1
Number of electrons                        I               10
Number of alpha electrons                  I                5
Number of beta electrons                   I                5
Number of basis functions                  I               13
Number of independent functions            I               13
Number of point charges in /Mol/           I                0
Number of translation vectors              I                0
Atomic numbers                             I   N=           3
           8           1           1
Nuclear charges                            R   N=           3
  8.00000000E+00  1.00000000E+00  1.00000000E+00
Current cartesian coordinates              R   N=           9
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00  1.60017436E+00
 -2.17104966E-02  4.86644352E-01  7.95980993E-02  9.86248069E-03
Force Field                                I                0
Int Atom Types                             I   N=           3
           0           0           0
MM charges                                 R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Integer atomic weights                     I   N=           3
          16           1           1
Real atomic weights                        R   N=           3
  1.59949146E+01  1.00782504E+00  1.00782504E+00
Atom fragment info                         I   N=           3
           0           0           0
Atom residue num                           I   N=           3
           0           0           0
Nuclear spins                              I   N=           3
           0           1           1
Nuclear ZEff                               R   N=           3
 -5.60000000E+00 -1.00000000E+00 -1.00000000E+00
Nuclear ZNuc                               R   N=           3
  8.00000000E+00  1.00000000E+00  1.00000000E+00
Nuclear QMom                               R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Nuclear GFac                               R   N=           3
  0.00000000E+00  2.79284600E+00  2.79284600E+00
MicOpt                                     I   N=           3
          -1          -1          -1
Number of contracted shells                I                7
Number of primitive shells                 I               12
Pure/Cartesian d shells                    I                1
Pure/Cartesian f shells                    I                1
Highest angular momentum                   I                1
Largest degree of contraction              I                3
Shell types                                I   N=           7
           0          -1          -1           0           0           0
           0
Number of primitives per shell             I   N=           7
           3           2           1           2           1           2
           1
Shell to atom map                          I   N=           7
           1           1           1           2           2           3
           3
Primitive exponents                        R   N=          12
  3.22037000E+02  4.84308000E+01  1.04206000E+01  7.40294000E+00  1.57620000E+00
  3.73684000E-01  5.44717800E+00  8.24547240E-01  1.83191580E-01  5.44717800E+00
  8.24547240E-01  1.83191580E-01
Contraction coefficients                   R   N=          12
  5.92393934E-02  3.51499961E-01  7.07657921E-01 -4.04453583E-01  1.22156176E+00
  1.00000000E+00  1.56284979E-01  9.04690877E-01  1.00000000E+00  1.56284979E-01
  9.04690877E-01  1.00000000E+00
P(S=P) Contraction coefficients            R   N=          12
  0.00000000E+00  0.00000000E+00  0.00000000E+00  2.44586107E-01  8.53955373E-01
  1.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00
Coordinates of each shell                  R   N=          21
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.32695832E+00 -1.05938614E-01
  1.87882241E-02 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00
  1.60017436E+00 -2.17104966E-02 -1.93166520E+00  1.60017436E+00 -2.17104966E-02
  4.86644352E-01  7.95980993E-02  9.86248069E-03  4.86644352E-01  7.95980993E-02
  9.86248069E-03
Constraint Structure                       R   N=           9
 -1.32695832E+00 -1.05938614E-01  1.87882241E-02 -1.93166520E+00  1.60017436E+00
 -2.17104966E-02  4.86644352E-01  7.95980993E-02  9.86248069E-03
Num ILSW                                   I              100
ILSW                                       I   N=         100
           1           1           0           0           2           0
           0           0           0           0           0          -1
           0           0           0           1           0           0
           0           0           0           0           0           0
           1           1           0           0           0           0
           0           0      100000           0          -1           0
           0           0           0           0           0           0
           0           0           0           1           0           0
           0           0           1           0           0           0
           0           0           4          41           0           0
           0           0           0           0           0           0
           0           0           0           3           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Num RLSW                                   I               41
RLSW                                       R   N=          41
  1.00000000E+00  1.00000000E+00  1.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  1.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  1.00000000E+00  1.00000000E+00
  0.00000000E+00
MxBond                                     I                2
NBond                                      I   N=           3
           2           1           1
IBond                                      I   N=           6
           2           3           1           0           1           0
RBond                                      R   N=           6
  1.00000000E+00  1.00000000E+00  1.00000000E+00  0.00000000E+00  1.00000000E+00
  0.00000000E+00
Virial Ratio                               R      2.001756519781691E+00
SCF Energy                                 R     -7.558532570429206E+01
Total Energy                               R     -7.558532570429206E+01
S**2                                       R      1.776356839400251E-15
S**2 after annihilation                    R      1.776356839400254E-15
RMS Density                                R      6.067827583034116E-10
External E-field                           R   N=          35
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
IOpCl                                      I                1
IROHF                                      I                0
Alpha Orbital Energies                     R   N=          13
 -2.04297795E+01 -1.32839993E+00 -6.82002142E-01 -5.38767334E-01 -4.79934816E-01
  2.62305860E-01  3.60309756E-01  1.18677618E+00  1.30827371E+00  1.78180383E+00
  1.86966403E+00  2.01413260E+00  3.11256620E+00
Beta Orbital Energies                      R   N=          13
 -2.04297795E+01 -1.32839993E+00 -6.82002142E-01 -5.38767334E-01 -4.79934816E-01
  2.62305860E-01  3.60309756E-01  1.18677618E+00  1.30827371E+00  1.78180383E+00
  1.86966403E+00  2.01413260E+00  3.11256620E+00
Alpha MO coefficients                      R   N=         169
  9.83233899E-01  9.58463391E-02  1.88750561E-03  3.00933014E-03 -7.85410800E-05
 -3.79135836E-02 -3.60972070E-03 -5.80733695E-03  1.51488012E-04  2.64516541E-03
  6.92318514E-03  2.65456006E-03  6.77097739E-03 -2.29162541E-01  2.17530408E-01
  4.34495281E-02  7.10960067E-02 -1.85279789E-03  7.06943412E-01  4.96654402E-02
  7.96881116E-02 -2.07903405E-03  1.17642634E-01  1.91844250E-02  1.15170013E-01
  1.96549799E-02 -1.03330237E-03  6.50462051E-04  3.35133926E-01 -2.15147968E-01
  4.48422079E-03  5.28170684E-03  3.12568729E-01 -1.99937826E-01  4.16449079E-03
 -2.34011521E-01 -1.84826668E-01  2.31814194E-01  1.86019113E-01  8.88460340E-02
 -8.27120954E-02  2.36980023E-01  3.71444444E-01 -9.70403126E-03 -4.06632282E-01
  2.72194642E-01  4.26240996E-01 -1.11362105E-02  1.30905470E-01  1.04911418E-01
  1.32780319E-01  1.08714416E-01  1.91546403E-11 -1.85557282E-11  1.25443751E-03
  1.28212655E-02  5.21398206E-01 -1.07867861E-10  1.51972490E-03  1.55326959E-02
  6.31663058E-01  4.84526262E-11  9.79552608E-11  8.15404582E-12  8.28760953E-12
 -1.08664463E-01  3.47985480E-02  1.16792672E-01  1.76291173E-01 -4.61602090E-03
  1.03754856E+00  2.59167046E-01  3.92334765E-01 -1.02711075E-02 -4.52521119E-02
 -8.50558615E-01 -4.75660670E-02 -8.69242587E-01  1.44542424E-03 -2.46324510E-04
  2.56249463E-01 -1.63954999E-01  3.41516638E-03 -1.79988379E-02  6.50715573E-01
 -4.16934234E-01  8.68691612E-03  3.77102984E-02  1.18473780E+00 -3.90730672E-02
 -1.15927293E+00  1.10762081E-03 -3.19393067E-03 -1.56206450E-01  9.03240763E-02
 -1.84526476E-03  6.30106009E-03 -3.70943321E-01  2.33868057E-01 -4.85839652E-03
 -9.39608766E-01  6.78315510E-01  9.83895693E-01 -7.10060657E-01  6.78879214E-02
 -1.00569472E-01 -1.48263505E-01 -2.40661619E-01  6.27461653E-03 -1.05562969E-01
 -1.39653782E-01 -2.59919005E-01  6.72744450E-03  1.00802184E+00 -5.00044119E-01
  9.56903028E-01 -4.77467310E-01 -4.07068076E-12  1.32658754E-11  2.47525860E-03
  2.52989473E-02  1.02882401E+00  8.40823396E-12 -2.32184300E-03 -2.37309279E-02
 -9.65057881E-01 -3.14446272E-11 -1.41539884E-11 -1.42218098E-11  9.87599497E-12
 -4.59528509E-02  1.40740541E-01 -5.32367082E-01 -8.56097566E-01  2.23324039E-02
  1.67317191E-01  6.07848474E-01  9.82911294E-01 -2.56323753E-02 -2.67432634E-01
 -9.50620250E-02 -2.67866205E-01 -8.19727255E-02 -2.98416367E-04  1.95681730E-03
 -9.05323672E-01  5.63977138E-01 -1.16901604E-02 -3.56406478E-03  1.17875809E+00
 -7.35538072E-01  1.52510125E-02  1.31416982E-01  5.05564351E-01 -1.40812835E-01
 -5.00427404E-01  8.46144580E-02 -1.63995218E+00 -8.77708985E-02 -1.38414354E-01
  3.61480009E-03  1.98805284E+00  2.66036438E-01  4.27676880E-01 -1.11567029E-02
 -2.91124366E-01 -3.60494228E-01 -2.90744521E-01 -3.50869080E-01
Beta MO coefficients                       R   N=         169
  9.83233899E-01  9.58463391E-02  1.88750561E-03  3.00933014E-03 -7.85410800E-05
 -3.79135836E-02 -3.60972070E-03 -5.80733695E-03  1.51488012E-04  2.64516541E-03
  6.92318514E-03  2.65456006E-03  6.77097739E-03 -2.29162541E-01  2.17530408E-01
  4.34495281E-02  7.10960067E-02 -1.85279789E-03  7.06943412E-01  4.96654402E-02
  7.96881116E-02 -2.07903405E-03  1.17642634E-01  1.91844250E-02  1.15170013E-01
  1.96549799E-02 -1.03330237E-03  6.50462051E-04  3.35133926E-01 -2.15147968E-01
  4.48422079E-03  5.28170684E-03  3.12568729E-01 -1.99937826E-01  4.16449079E-03
 -2.34011521E-01 -1.84826668E-01  2.31814194E-01  1.86019113E-01  8.88460340E-02
 -8.27120954E-02  2.36980023E-01  3.71444444E-01 -9.70403126E-03 -4.06632282E-01
  2.72194642E-01  4.26240996E-01 -1.11362105E-02  1.30905470E-01  1.04911418E-01
  1.32780319E-01  1.08714416E-01  1.91546403E-11 -1.85557282E-11  1.25443751E-03
  1.28212655E-02  5.21398206E-01 -1.07867861E-10  1.51972490E-03  1.55326959E-02
  6.31663058E-01  4.84526262E-11  9.79552608E-11  8.15404582E-12  8.28760953E-12
 -1.08664463E-01  3.47985480E-02  1.16792672E-01  1.76291173E-01 -4.61602090E-03
  1.03754856E+00  2.59167046E-01  3.92334765E-01 -1.02711075E-02 -4.52521119E-02
 -8.50558615E-01 -4.75660670E-02 -8.69242587E-01  1.44542424E-03 -2.46324510E-04
  2.56249463E-01 -1.63954999E-01  3.41516638E-03 -1.79988379E-02  6.50715573E-01
 -4.16934234E-01  8.68691612E-03  3.77102984E-02  1.18473780E+00 -3.90730672E-02
 -1.15927293E+00  1.10762081E-03 -3.19393067E-03 -1.56206450E-01  9.03240763E-02
 -1.84526476E-03  6.30106009E-03 -3.70943321E-01  2.33868057E-01 -4.85839652E-03
 -9.39608766E-01  6.78315510E-01  9.83895693E-01 -7.10060657E-01  6.78879214E-02
 -1.00569472E-01 -1.48263505E-01 -2.40661619E-01  6.27461653E-03 -1.05562969E-01
 -1.39653782E-01 -2.59919005E-01  6.72744450E-03  1.00802184E+00 -5.00044119E-01
  9.56903028E-01 -4.77467310E-01 -4.07068076E-12  1.32658754E-11  2.47525860E-03
  2.52989473E-02  1.02882401E+00  8.40823396E-12 -2.32184300E-03 -2.37309279E-02
 -9.65057881E-01 -3.14446272E-11 -1.41539884E-11 -1.42218098E-11  9.87599497E-12
 -4.59528509E-02  1.40740541E-01 -5.32367082E-01 -8.56097566E-01  2.23324039E-02
  1.67317191E-01  6.07848474E-01  9.82911294E-01 -2.56323753E-02 -2.67432634E-01
 -9.50620250E-02 -2.67866205E-01 -8.19727255E-02 -2.98416367E-04  1.95681730E-03
 -9.05323672E-01  5.63977138E-01 -1.16901604E-02 -3.56406478E-03  1.17875809E+00
 -7.35538072E-01  1.52510125E-02  1.31416982E-01  5.05564351E-01 -1.40812835E-01
 -5.00427404E-01  8.46144580E-02 -1.63995218E+00 -8.77708985E-02 -1.38414354E-01
  3.61480009E-03  1.98805284E+00  2.66036438E-01  4.27676880E-01 -1.11567029E-02
 -2.91124366E-01 -3.60494228E-01 -2.90744521E-01 -3.50869080E-01
Total SCF Density                          R   N=          91
  2.05431811E+00  7.40804699E-02  1.26695426E-01  2.52145914E-02 -1.95012366E-02
  3.40734555E-01  3.97800249E-02 -3.02178345E-02  3.80647621E-02  3.78975413E-01
 -1.03886124E-03  7.89979621E-04 -4.46874012E-04  3.96748491E-03  5.43947609E-01
 -4.70831985E-01  3.67569308E-01 -1.27897706E-01 -2.04061783E-01  5.32562235E-03
  1.33316827E+00  1.78595564E-02 -2.37054204E-02  3.42820222E-01  7.47925937E-02
 -1.07822560E-03 -1.47569438E-01  3.48542259E-01  2.82098351E-02 -3.72147250E-02
  7.49511734E-02  4.14376492E-01  5.83741724E-03 -2.35648399E-01  1.15057033E-01
  4.56563412E-01 -7.36652857E-04  9.72149167E-04 -1.08212510E-03  5.83779877E-03
  6.58957132E-01  6.14967073E-03 -1.74675226E-03  8.13105492E-03  7.98287844E-01
 -2.49724644E-02  2.97293964E-02 -8.45734171E-02  2.14686189E-01 -5.07569171E-03
  5.72000541E-02 -6.33593821E-02  2.23888782E-01 -5.35302399E-03  1.71488840E-01
  2.38454080E-02 -7.92181645E-03 -7.24663098E-02  1.60237232E-01 -3.76591167E-03
 -6.06734992E-02 -5.65737974E-02  1.66319910E-01 -3.95372166E-03  1.18520535E-01
  9.11665513E-02 -2.44502576E-02  2.89513152E-02  2.28328355E-01  1.52845507E-02
 -9.25187166E-04  5.70992966E-02  2.28620693E-01  3.88205088E-02 -1.50464349E-03
 -4.66191930E-02 -5.33748501E-02  1.69279225E-01  2.32398001E-02 -7.89293913E-03
  1.77942480E-01  3.55499647E-03 -5.15531634E-04 -5.91720920E-02  1.77373942E-01
  2.13464615E-02 -9.51658762E-04 -5.39382594E-02 -4.51039261E-02  1.19677287E-01
  9.37081976E-02
Spin SCF Density                           R   N=          91
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00
Mulliken Charges                           R   N=           3
 -7.24461767E-01  3.63043495E-01  3.61418272E-01
ONIOM Charges                              I   N=          16
           0           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
ONIOM Multiplicities                       I   N=          16
           1           0           0           0           0           0
           0           0           0           0           0           0
           0           0           0           0
Atom Layers                                I   N=           3
           1           1           1
Atom Modifiers                             I   N=           3
           0           0           0
Force Field                                I                0
Int Atom Modified Types                    I   N=           3
           0           0           0
Link Atoms                                 I   N=           3
           0           0           0
Atom Modified MM Charges                   R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Link Distances                             R   N=          12
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00
Cartesian Gradient                         R   N=           9
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
Dipole Moment                              R   N=           3
  5.15346378E-01  8.13553371E-01 -2.12452852E-02
Quadrupole Moment                          R   N=           6
 -1.50772647E-01  6.97836931E-01 -5.47064284E-01 -1.48317294E+00  4.22126276E-02
 -1.64760439E-02
Anisotropic Hyperfine tensors              R   N=          18
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00  0.00000000E+00
  0.00000000E+00  0.00000000E+00  0.00000000E+00
Isotropic Hyperfine splittings             R   N=           3
  0.00000000E+00  0.00000000E+00  0.00000000E+00
QEq coupling tensors                       R   N=          18
 -1.38887030E+00  7.04259404E-01 -6.92045268E-01 -8.96597254E-03  6.65328662E-02
  2.08091557E+00  1.48720977E-01  2.95841762E-01 -4.82586853E-01 -6.82824746E-03
  1.93762470E-02  3.33865876E-01 -5.74458624E-01 -5.38520401E-02  2.51944229E-01
  3.48239778E-03  1.86622939E-03  3.22514395E-01
)";

TEST_CASE("H2 fchk", "[read]") {
    std::istringstream fchk(fchk_contents);
    occ::io::FchkReader reader(fchk);
    REQUIRE(reader.num_alpha() == 1);
    REQUIRE(reader.num_basis_functions() == 2);
    fmt::print("Alpha MOs:\n{}\n", reader.alpha_mo_coefficients());
    fmt::print("Alpha MO energies:\n{}\n", reader.alpha_mo_energies());
    fmt::print("Positions:\n{}\n", reader.atomic_positions());
    REQUIRE(reader.basis().primitive_exponents[0] == Approx(3.42525091));

    occ::io::FchkReader::FchkBasis basis = reader.basis();
    basis.print();
    //    fmt::print("Libint2 basis:\n");
    //    for(const auto& shell: reader.basis_set())
    //    {
    //        fmt::print("\n{}\n", shell);
    //    }
    auto density = reader.scf_density_matrix();
    fmt::print("Density matrix\n{}\n", density);

    REQUIRE(density(1, 0) == Approx(0.301228));
}

TEST_CASE("Write H2 fchk", "[write]") {
    occ::io::FchkWriter writer(std::cout);
    writer.set_scalar("Charge", 0);
    writer.set_scalar("Multiplicity", 1);
    writer.set_scalar("Number of electrons", 10);
    writer.set_scalar("SCF Energy", -76.42165911602731);
    writer.set_scalar("Test string", std::string("this string"));
    Mat identity = Mat::Identity(3, 3);
    writer.set_vector("Identity matrix", identity);
    writer.write();
    REQUIRE(true);
}

TEST_CASE("water uhf fchk", "[read]") {
    std::istringstream fchk(unrestricted_fchk_contents);
    occ::io::FchkReader reader(fchk);
    REQUIRE(reader.num_alpha() == 5);
    REQUIRE(reader.num_beta() == 5);
    REQUIRE(reader.num_basis_functions() == 13);
    fmt::print("Alpha MOs:\n{}\n", reader.alpha_mo_coefficients());
    fmt::print("Beta MOs:\n{}\n", reader.alpha_mo_coefficients());
    fmt::print("Alpha MO energies:\n{}\n", reader.alpha_mo_energies());
    fmt::print("Beta MO energies:\n{}\n", reader.alpha_mo_energies());
    fmt::print("Positions:\n{}\n", reader.atomic_positions());
    CHECK(reader.basis().primitive_exponents[0] == Approx(3.22037000e02));

    occ::io::FchkReader::FchkBasis basis = reader.basis();
    basis.print();
    //    fmt::print("Libint2 basis:\n");
    //    for(const auto& shell: reader.basis_set())
    //    {
    //        fmt::print("\n{}\n", shell);
    //    }
    auto density = reader.scf_density_matrix();
    int nbf = 13;
    Mat density_expected(nbf, nbf);
    density_expected << 1.027159055811635913e+00, 3.704023489202387664e-02,
        1.260729573645737699e-02, 1.989001246282115845e-02,
        -5.194306171339705324e-04, -2.354159924174853424e-01,
        8.929778175037792615e-03, 1.410491755866299067e-02,
        -3.683264284039888077e-04, -1.248623214013617339e-02,
        1.192270398277695161e-02, -1.222512880781454966e-02,
        1.161990007192056397e-02, 3.704023489202387664e-02,
        6.334771294985715173e-02, -9.750618291678152944e-03,
        -1.510891725501560187e-02, 3.949898091787798038e-04,
        1.837846543064179383e-01, -1.185271014402013157e-02,
        -1.860736245068380507e-02, 4.860745829954922904e-04,
        1.486469825614799428e-02, -3.960908199636133109e-03,
        1.447565770463709982e-02, -3.946469581940933134e-03,
        1.260729573645737699e-02, -9.750618291678152944e-03,
        1.703672774402610057e-01, 1.903238124037974141e-02,
        -2.234370062451817760e-04, -6.394885284870387154e-02,
        1.714101107876532804e-01, 3.747558671183424950e-02,
        -5.410625524466284057e-04, -4.228670877418309881e-02,
        -3.623315486170241434e-02, 1.141641772014494183e-01,
        8.897124031412841083e-02, 1.989001246282115845e-02,
        -1.510891725501560187e-02, 1.903238124037974141e-02,
        1.894877061985975886e-01, 1.983742456148060874e-03,
        -1.020308913292919395e-01, 3.739629697712439083e-02,
        2.071882458996356091e-01, 2.918899383189254605e-03,
        1.073430944241324791e-01, 8.011861553997037810e-02,
        7.642275436028479405e-03, 1.777498323894319537e-03,
        -5.194306171339705324e-04, 3.949898091787798038e-04,
        -2.234370062451817760e-04, 1.983742456148060874e-03,
        2.719738047075293541e-01, 2.662811170929253561e-03,
        -5.391127968595087281e-04, 2.918708620554830071e-03,
        3.294785660005331573e-01, -2.537845853486923875e-03,
        -1.882955832520055890e-03, -4.625935829770838376e-04,
        -2.577658182671186912e-04, -2.354159924174853424e-01,
        1.837846543064179383e-01, -6.394885284870387154e-02,
        -1.020308913292919395e-01, 2.662811170929253561e-03,
        6.665841367832672226e-01, -7.378471882986549490e-02,
        -1.178241994049793046e-01, 3.074835361423340196e-03,
        2.860002713323228640e-02, -3.033674947761145699e-02,
        2.854964855994925055e-02, -2.958604610690653350e-02,
        8.929778175037792615e-03, -1.185271014402013157e-02,
        1.714101107876532804e-01, 3.739629697712439083e-02,
        -5.391127968595087281e-04, -7.378471882986549490e-02,
        1.742711290797470391e-01, 5.752851659054463579e-02,
        -8.733761301656478267e-04, -3.167969125219934762e-02,
        -2.828689868979465671e-02, 1.143103465506893623e-01,
        8.868697115510079665e-02, 1.410491755866299067e-02,
        -1.860736245068380507e-02, 3.747558671183424950e-02,
        2.071882458996356091e-01, 2.918708620554830071e-03,
        -1.178241994049793046e-01, 5.752851659054463579e-02,
        2.282817058714250447e-01, 4.065527461716612195e-03,
        1.119443906633796754e-01, 8.315995481986421245e-02,
        1.941025435977715430e-02, 1.067323079244111329e-02,
        -3.683264284039888077e-04, 4.860745829954922904e-04,
        -5.410625524466284057e-04, 2.918899383189254605e-03,
        3.294785660005331573e-01, 3.074835361423340196e-03,
        -8.733761301656478267e-04, 4.065527461716612195e-03,
        3.991439223409505299e-01, -2.676511993842408017e-03,
        -1.976860822710261884e-03, -7.523217461259853458e-04,
        -4.758293834331794002e-04, -1.248623214013617339e-02,
        1.486469825614799428e-02, -4.228670877418309881e-02,
        1.073430944241324791e-01, -2.537845853486923875e-03,
        2.860002713323228640e-02, -3.167969125219934762e-02,
        1.119443906633796754e-01, -2.676511993842408017e-03,
        8.574442027115855569e-02, 5.926026744033328908e-02,
        -2.330959662430042573e-02, -2.696912988410838166e-02,
        1.192270398277695161e-02, -3.960908199636133109e-03,
        -3.623315486170241434e-02, 8.011861553997037810e-02,
        -1.882955832520055890e-03, -3.033674947761145699e-02,
        -2.828689868979465671e-02, 8.315995481986421245e-02,
        -1.976860822710261884e-03, 5.926026744033328908e-02,
        4.558327548581628946e-02, -2.668742503593509591e-02,
        -2.255196308268581779e-02, -1.222512880781454966e-02,
        1.447565770463709982e-02, 1.141641772014494183e-01,
        7.642275436028479405e-03, -4.625935829770838376e-04,
        2.854964855994925055e-02, 1.143103465506893623e-01,
        1.941025435977715430e-02, -7.523217461259853458e-04,
        -2.330959662430042573e-02, -2.668742503593509591e-02,
        8.463961223714372428e-02, 5.983864384181302593e-02,
        1.161990007192056397e-02, -3.946469581940933134e-03,
        8.897124031412841083e-02, 1.777498323894319754e-03,
        -2.577658182671185827e-04, -2.958604610690653697e-02,
        8.868697115510079665e-02, 1.067323079244111676e-02,
        -4.758293834331793460e-04, -2.696912988410838166e-02,
        -2.255196308268581432e-02, 5.983864384181302593e-02,
        4.685409901721312304e-02;

    for (int i = 0; i < nbf; i++) {
        for (int j = 0; j < nbf; j++) {
            INFO("DENSITY(" << i << ", " << j << ")");
            CHECK(density(i, j) == Approx(density_expected(i, j)));
        }
    }
}
